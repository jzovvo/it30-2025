# ç…‰é‡‘å·¥æˆ¿çš„æ ¸å¿ƒè¨­æ–½ï¼šèªè­˜é­”æ³•ç†”çˆ PostCSS

æˆ‘å€‘åœ¨å­¸æœƒä¸‰å¤§å…¬å¼ä¸¦é–‹å§‹å˜—è©¦é‹ç”¨åˆ°é–‹ç™¼ä¸­ä¹‹å¾Œï¼Œæœƒç™¼ç¾ä¸€å€‹å¤§å•é¡Œï¼šä»¥å‰å±¬æ€§å€¼å¯« `??px` å°±æå®šäº†ï¼Œç¾åœ¨å»è¦å¯«ä¸€å †å­—ã€‚æ‰€ä»¥æˆ‘å€‘éœ€è¦ä¸€ç¨®èˆ‡éå»é–‹ç™¼é«”é©—é¡ä¼¼çš„æ–¹æ³•ï¼Œå¦å‰‡ä½ ç„¡æ³•èªªæœåŒäº‹é™ªä½ ä¸€èµ·ç­‰æ¯”ç¸®æ”¾ Q_Qã€‚

é‚£æœ‰æ²’æœ‰å¯èƒ½æˆ‘å€‘å±¬æ€§å€¼å¯«ä¸€å€‹å‡½å¼å‘¼å«ï¼Œä¸¦å¯ä»¥å°‡å‡½å¼é‹ç®—å¾Œï¼Œç”¨çµæœæ›¿æ›æ‰è©²å‡½å¼å‘¼å«çš„å­—ä¸²å‘¢ï¼Ÿä¾‹å¦‚ï¼š

- `pxToVw(è¨­è¨ˆç¨¿ä¸Šçš„å€¼, è¨­è¨ˆç¨¿å¯¬åº¦)`ï¼šåŸ·è¡Œ `è¨­è¨ˆç¨¿ä¸Šçš„å€¼ / è¨­è¨ˆç¨¿å¯¬åº¦ * 100vw` é‹ç®—æ›¿æ›ã€‚
- `pxToVwClamp(è¨­è¨ˆç¨¿ä¸Šçš„å€¼, è¨­è¨ˆç¨¿å¯¬åº¦)`ï¼šåŸ·è¡Œ `min(è¨­è¨ˆç¨¿ä¸Šçš„å€¼px, è¨­è¨ˆç¨¿ä¸Šçš„å€¼ / è¨­è¨ˆç¨¿å¯¬åº¦ * 100vw)` é‹ç®—æ›¿æ›ã€‚
- `pxToVwExtend(è¨­è¨ˆç¨¿ä¸Šçš„å€¼, è¨­è¨ˆç¨¿å¯¬åº¦)`ï¼šåŸ·è¡Œ `calc((100vw - è¨­è¨ˆç¨¿å¯¬åº¦) / 2 + (è¨­è¨ˆç¨¿ä¸Šçš„å€¼))` é‹ç®—æ›¿æ›ã€‚

```css
body {
  width: pxToVw(10,100); /* calc( è¨­è¨ˆç¨¿ä¸Šçš„å€¼ / è¨­è¨ˆç¨¿å¯¬åº¦ * 100vw ) */
  height: pxToVwClamp(10,100); /* min( è¨­è¨ˆç¨¿ä¸Šçš„å€¼px, calc( è¨­è¨ˆç¨¿ä¸Šçš„å€¼ / è¨­è¨ˆç¨¿å¯¬åº¦ * 100vw )) */
  margin-left: pxToVwExtend(10,100); /* calc((100vw - è¨­è¨ˆç¨¿å¯¬åº¦) / 2 + (è¨­è¨ˆç¨¿ä¸Šçš„å€¼)) */
}
```

æ›¿æ›æˆ

```css
body {
  /* 10 / 100 * 100 = 10 */
  width: 10vw;
  height: min(10px, 10vw);
  margin-left: calc((100vw - 100px) * 0.5 + 10px);
}
```

è¦åšåˆ°é€™ä»¶äº‹æƒ…ï¼Œæˆ‘å€‘éœ€è¦å…·å‚™å…©å€‹ä½œç”¨çš„å·¥å…·ï¼š

1. **æ‹¿åˆ°æ‰€æœ‰ css å±¬æ€§å€¼**ä¾†ç²å–æˆ‘å€‘å¯«çš„å‡½å¼å‘¼å«å­—ä¸²ã€‚
2. å°‡å‡½å¼å‘¼å«é‹ç®—å¾Œ**æ›¿æ›åŸæœ¬çš„ css**ã€‚

æˆ‘ç›®å‰å·¥ä½œä¸Šä½¿ç”¨çš„æ˜¯ `postcss`ï¼Œ`postcss` æœ¬è³ªä¸Šå°±æ˜¯ï¼š

1. å°‡ä½ çš„ `css` å­—ä¸²è§£ææˆä¸€å€‹å¤§ jsonã€‚
2. é€šéå„ç¨® hook å°‡é€™å€‹å¤§ json å‚³çµ¦ä½ ï¼ˆæ‹¿åˆ°åŸæœ¬çš„ `css`ï¼‰ã€‚
3. ä½ å°é€™å€‹å¤§ json é€²è¡Œä¿®æ”¹å¾Œã€‚
4. ä»–å†å°‡æœ€æ–°çš„å¤§ json ç·¨è­¯æˆæ–°çš„ `css` å­—ä¸²ï¼ˆæ›¿æˆ¶åŸæœ¬çš„ `css`ï¼‰ã€‚

ä¹Ÿå°±æ˜¯èªª `postcss` æ˜¯ä¸€å€‹æä¾› plugin ç³»çµ±çš„ JS å·¥å…·ï¼Œä¸»è¦ç”¨ä¾†è§£æè½‰æ› cssï¼Œé€™å·¥å…·å®Œå…¨å…·æœ‰æˆ‘å€‘æ‰€éœ€çš„å…©å€‹æ¢ä»¶ã€‚

![](./assets/flow.png)

## æ ¸å¿ƒé‚è¼¯

ç¤ºç¯„ç”¨ `postcss` å»ä¿®æ”¹é€™å€‹ cssã€‚

**normal.css**

```css
/* hello world */
@keyframes aaa {
  0% {
    color: red;
  }
  100% {
    color: blue;
  }
}

.apple {
  color: yellow;
  font-size: 100px;
}
```

**package.json**

```json
{
  "dependencies": {
    "postcss": "^8.5.6"
  },
  "type": "module"
}
```

**main.js**

```js
import fs from 'fs'
import postcss from 'postcss'

/**
 * @type {import('postcss').PluginCreator}
 */
const plugin = function () {
  return {
    // plugin åå­—ï¼Œéš¨ä¾¿å–ã€‚
    postcssPlugin: ' :) ',
    Comment: (comment) => {
      console.log('[ Comment ]')
      console.log(comment.text)

      comment.text = ':)'
    },
    Declaration: (decl) => {
      console.log('[ Declaration ]')
      console.log(`${decl.prop}: ${decl.value}`)

      if (decl.prop === 'color') {
        decl.value = 'chocolate'
      }
    },
  }
}

plugin.postcss = true

fs.readFile('./normal.css', (_, data) => {

  postcss([plugin])
    .process(data, {from:'./normal.css'})
    .then((result) => {
      console.log('[ Final ]')
      console.log(result.css)
    })
})
```

`postcss` æ ¸å¿ƒæµç¨‹å°±ä¸‰å€‹ï¼š

1. `postcss()`ï¼šå®‰è£æ’ä»¶ã€‚
2. `.process()`ï¼šè™•ç†æ•¸æ“šã€‚
3. `.then()`ï¼šç²å–è™•ç†å¾Œçµæœã€‚

æˆ‘åšäº†å¹¾ä»¶äº‹æƒ…ï¼š

1. å»ºç«‹æ’ä»¶
   - ç›£è½ `Comment`ï¼šç•¶ postcss è§£æåˆ° CSS è¨»è§£æ™‚ï¼ŒæœƒåŸ·è¡Œé€™å€‹ hookï¼Œæ­¤æ™‚æˆ‘å°‡è¨»è§£éƒ½æ”¹æˆ `:)`ã€‚
   - ç›£è½ `Declaration`ï¼šç•¶ postcss è§£æåˆ°æ¯ä¸€å¥ CSS è¨­å®šæ™‚ï¼ŒæœƒåŸ·è¡Œé€™å€‹ hookï¼Œä¾‹å¦‚ `color: red;`ï¼Œæ­¤æ™‚æˆ‘å°‡ `color` éƒ½æ”¹æˆ `chocolate`ã€‚
   - æ³¨æ„ï¼æ’ä»¶ä¸€å®šè¦å¯« `.postcss = true`ï¼Œé€™æ˜¯ `postcss` è¦å®šçš„ã€‚
2. è®€å– `normal.css` çš„å…§å®¹ã€‚
3. å®‰è£æ’ä»¶ ( `postcss([plugin])` )ã€‚
4. å‚³å…¥è¦è§£æçš„å…§å®¹ ( `.process(data, { from: "./normal.css" })` )
   - `from` åƒæ•¸æ¨è–¦è¦å¯«ï¼Œä¸å¯«ç·¨è­¯å™¨æœƒç½µä½ ã€‚
   - `process` åŸ·è¡Œå¾Œï¼š
     1. æŠŠä½ å‚³å…¥çš„å…§å®¹è§£ææˆä¸€å€‹å¤§ JSONã€‚
     2. å°‡å¤§ json å‚³å…¥æ‰€æœ‰å®‰è£éçš„æ’ä»¶ä¸­ã€‚
     3. æ’ä»¶ç›£è½çš„ hook å°±æœƒåŸ·è¡Œï¼Œæ­¤æ™‚ä½ å°±èƒ½ä¿®æ”¹å…§å®¹ã€‚
     4. å¦‚æœå…§å®¹æœ‰è¢«æ”¹ï¼Œå°±æœƒå†æ¬¡æ‹¿è‘—æ›´æ–°å¾Œçš„å…§å®¹ï¼ŒåŸ·è¡Œä¸€éæ›´æ–°å…§å®¹çš„ hook å€‘ï¼Œç›´åˆ°å¤§ json æ²’æœ‰å†è¢«æ›´æ”¹ç‚ºæ­¢ã€‚
5. `then` è¿”å›æœ€çµ‚çµæœã€‚
   - è£¡é¢æœ‰å€‹ `.css` æ˜¯ç¶“éä¿®æ”¹å¾Œçš„æ–° css å­—ä¸²ã€‚

**çµæœ**

```shell
% node ./main.js
[ Comment ]
hello world
[ Declaration ]
color: red
[ Declaration ]
color: blue
[ Declaration ]
color: yellow
[ Declaration ]
font-size: 100px


[ Comment ]
:)
[ Declaration ]
color: chocolate
[ Declaration ]
color: chocolate
[ Declaration ]
color: chocolate


[ Final ]
/* :) */
@keyframes aaa {
  0% {
    color: chocolate;
  }
  100% {
    color: chocolate;
  }
}

.apple {
  color: chocolate;
  font-size: 100px;
}
```

- è¨»è§£è®Šæˆ `:)` è€Œ `color` éƒ½è®Šæˆ `chocolate`ã€‚
- `Postcss` çš„ hook æœ‰å€‹é‡è¦ç‰¹æ€§ï¼šå¦‚æœå¤§ json çš„æŸå€‹å€¼è¢«æ›´æ–°å¾Œï¼Œå°±æœƒå†æ¬¡åŸ·è¡Œä¸€è¼ª hookï¼Œä½†æ˜¯åªæœ‰åƒèˆ‡æ›´æ–°çš„ Hook èˆ‡æ•¸æ“šæœƒè¢«å†æ¬¡åŸ·è¡Œã€‚ä¸æ®µé‡è¤‡ï¼Œç›´åˆ°æ²’æœ‰æ•¸æ“šæ›´æ–°ç‚ºæ­¢ï¼Œä»¥æ­¤ä¿è­‰æ‰€æœ‰æ•¸æ“šéƒ½å¯ä»¥è¢«å®Œæ•´æ›´æ–°ã€‚
  - è¼¸å‡ºçš„çµæœçœ‹èµ·ä¾†åŸ·è¡Œäº†å…©è¼ªã€‚
  - ä½†æ˜¯ `font-size` æ²’æœ‰åœ¨ç¬¬äºŒè¼ªå‡ºç¾ï¼Œå› ç‚º `font-size` åœ¨ç¬¬ä¸€è¼ªçš„ `Declaration` æ²’æœ‰è¢«æ›´æ–°ã€‚
  - ä¸¦ä¸”ä¹Ÿæ²’æœ‰ç¬¬ä¸‰è¼ªï¼Œå› ç‚ºç¬¬äºŒè¼ªå°±æ²’æœ‰æ±è¥¿è¢«æ›´æ–°äº†ã€‚

ä»¥ä¸Šå°±æ˜¯ `postcss` çš„é‹è¡Œé‚è¼¯ï¼Œä¸éå¤§éƒ¨åˆ†çš„äººå¯¦éš›ä¸Šéƒ½ä¸æ˜¯é€™æ¨£ç”¨ `postcss` çš„ï¼Œè€Œæ˜¯é€éä¸€äº›æ¥å£ä¾†å•Ÿå‹• `postcss` é–‹é—œï¼Œä¸‹ç¯‡æˆ‘å€‘è¦ä¾†ä»‹ç´¹å…¶ä¸­ä¸€å€‹é–‹é—œï¼Œé‚£æˆ‘å€‘ä¸‹ç¯‡è¦‹å›‰ï½

## è£œå……èªªæ˜

### hook

hook åœ¨ `postcss` è£¡é¢å« `visitor`ï¼Œä¸éæˆ‘é‚„æ˜¯ç¿’æ…£å«ä»– `hook`ï¼Œæ‰€ä»¥å¾Œé¢æˆ‘éƒ½æœƒç”¨ `hook`ã€‚

### å¤§ json

å°ˆæœ‰åè©å«åš `AST ( æŠ½è±¡èªæ³•æ¨¹ï¼ŒAbstract Syntax Tree )`ï¼Œé€™æ˜¯ç›¸ç•¶é¾å¤§çš„ä¸»é¡Œï¼Œå¯¦åœ¨æ²’è¾¦æ³•åœ¨é€™å±•é–‹è¬›ï¼ˆè€Œä¸”æˆ‘ä¹Ÿä¸æ‡‚ğŸ˜†ï¼‰ï¼Œç¸½ä¹‹å°±æ˜¯ç”¨ä¸€å€‹æ¨¹ç‹€çµæ§‹å»è§£é‡‹åŸå§‹ç¢¼çš„æ¯ä¸€å€‹ç¯€é»ï¼ˆnodeï¼‰çš„æŠ€è¡“ã€‚

ç”¨åœ‹æ–‡èª²çš„æ–¹å¼åˆ†äº«æˆ‘å° `AST` çš„ç†è§£ï¼Œåœ‹æ–‡èª²æ‡‰è©²éƒ½æœƒè¬›ä»€éº¼ä¸»è©ã€å‹•è©ã€ç‰©ä»¶ç­‰ï¼Œç¾åœ¨æˆ‘å€‘ä¾†åˆ†æé€™æ®µèˆ”ç‹—é‡‘å¥ï¼š

> **æˆ‘æ‡‰è©²åœ¨è»Šåº•ï¼Œä¸æ‡‰è©²åœ¨è»Šè£¡ï¼Œçœ‹åˆ°ä½ å€‘æœ‰å¤šç”œèœœã€‚**

```js
const sentenceAST = {
  type: 'å¥å­',
  value: 'æˆ‘æ‡‰è©²åœ¨è»Šåº•ï¼Œä¸æ‡‰è©²åœ¨è»Šè£¡ï¼Œçœ‹åˆ°ä½ å€‘æœ‰å¤šç”œèœœã€‚'
  nodes: [
    {
      type: 'å­å¥',
      value: 'æˆ‘æ‡‰è©²åœ¨è»Šåº•ï¼Œ'
      nodes: [
        {
          type: 'ä¸»è©',
          value: 'æˆ‘'
        },
        {
          type: 'å‹•è©',
          value: 'æ‡‰è©²åœ¨'
        },
        {
          type: 'ç‰©ä»¶',
          value: 'è»Šåº•'
        }
      ],
      attributes: {
        separator: 'ï¼Œ'
      }
    },
    {
      type: 'å­å¥',
      value: 'ä¸æ‡‰è©²åœ¨è»Šè£¡ï¼Œ'
      nodes: [
        {
          type: 'å‹•è©',
          value: 'ä¸æ‡‰è©²åœ¨'
        },
        {
          type: 'ç‰©ä»¶',
          value: 'è»Šè£¡'
        }
      ],
      attributes: {
        separator: 'ï¼Œ'
      }
    },
    {
      type: 'å­å¥',
      value: 'çœ‹åˆ°ä½ å€‘æœ‰å¤šç”œèœœã€‚'
      nodes: [
        {
          type: 'å‹•è©',
          value: 'çœ‹åˆ°'
        },
        {
          type: 'ç‰©ä»¶',
          value: 'ä½ å€‘æœ‰å¤šç”œèœœ'
        }
      ],
      attributes: {
        separator: 'ã€‚'
      }
    }
  ]
};
```

é€™å°±æ˜¯ `AST` åšçš„äº‹æƒ…ï¼Œä»–æ˜¯ä¸€ä½çµæ§‹æ‹†è§£å°ˆå®¶ã€‚

### Lightning.css

é›–ç„¶æˆ‘ç¾åœ¨æ˜¯ç”¨ `postcss`ï¼Œä½†åªè¦ç¬¦åˆ**ç²å– css å±¬æ€§å€¼**èˆ‡**ä¿®æ”¹ css å±¬æ€§å€¼**å…©å€‹æ¢ä»¶çš„å·¥å…·éƒ½å¯ä»¥ï¼Œç›®å‰å¸‚é¢ä¸Šæœ€æœ‰åçš„æ›¿ä»£æ–¹æ¡ˆæ‡‰è©²æ˜¯ç”¨ `Rust` å¯«çš„ `Lightning.css`ï¼Œä»–æœ‰å€‹ `transform` çš„ API ä¹Ÿèƒ½åšåˆ°ï¼Œä¸éç›®å‰ `postcss` å¸‚ä½”é‚„æ˜¯æœ‰ç›¸ç•¶å¤§çš„é ˜å…ˆï¼Œæ‰€ä»¥å¾Œé¢æˆ‘å€‘æœƒæŒçºŒåœç¹ `postcss`ï¼Œé€™é‚Šå°±ç•¶å€‹é¡å¤–è³‡è¨Šåˆ†äº«ï½

## åƒè€ƒé€£çµ

- [postcss](https://postcss.org/)
- [AST explorer](https://astexplorer.net/)
- [Lightning.css](https://lightningcss.dev/transforms.html)
